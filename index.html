<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Microwave Timer – fixed start/progress display</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root {
  --bg: #0d0d0d;
  --card: #161616;
  --text: #e8e8e8;
  --muted: #7a7a7a;
  --track: #1f1f1f;
  --fill-start: #005f99;
  --fill-end: #008644;
  --radius: 14px;
  --space: clamp(0.9rem,3vw,1.4rem);
  --mono: 'SFMono-Regular','Consolas','Liberation Mono',monospace;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  padding: var(--space);
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}
header { text-align: center; margin-bottom: clamp(1.2rem,4vw,2rem); }
h1 { font-size: clamp(1.6rem,4vw,2rem); font-weight: 600; }
h1 small { display: block; font-size: .78em; color: var(--muted); }
#card {
  background: var(--card);
  padding: var(--space);
  border-radius: var(--radius);
  box-shadow: 0 6px 18px rgba(0,0,0,0.35);
  flex: 1;
  display: flex;
  flex-direction: column;
}
.field { margin-top: var(--space); }
label {
  display: block;
  margin-bottom: .25rem;
  font-size: 1.05rem;
  color: var(--muted);
}
input[type=range] {
  width: 100%;
  height: 6px;
  background: #444;
  border-radius: 4px;
  outline: none;
  appearance: none;
  margin: .35rem 0;
}
input[type=range]::-webkit-slider-thumb {
  appearance: none;
  width: 22px; height: 22px;
  border-radius: 50%;
  background: var(--fill-end);
  border: none;
  cursor: pointer;
}
.value-display {
  margin-left: .4rem;
  font-size: 1.6rem;
  font-weight: 600;
  color: var(--text);
}
details {
  margin-top: var(--space);
  border-top: 1px dashed #333;
  padding-top: var(--space);
}
summary {
  cursor: pointer;
  color: var(--fill-end);
  font-weight: 500;
}
input[type=number] {
  width: 100%;
  padding: .6rem .8rem;
  margin-top: .25rem;
  font-size: 1rem;
  border: 1px solid #333;
  border-radius: var(--radius);
  background: #000;
  color: var(--text);
}
#startBtn {
  width: 100%;
  height: 54px;
  margin-top: var(--space);
  border-radius: var(--radius);
  background: linear-gradient(90deg, var(--fill-start), var(--fill-end));
  border: none;
  color: #000;
  font-size: 1.25rem;
  font-weight: 600;
  cursor: pointer;
}
#progressWrap {
  width: 100%;
  height: 54px;
  margin-top: var(--space);
  border-radius: var(--radius);
  background: var(--track);
  overflow: hidden;
  position: relative;
  display: none;
}
#progressBar {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, var(--fill-start), var(--fill-end));
}
#barLabel {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  font-family: var(--mono);
  font-size: 1.4rem;
  color: #fff;
  text-shadow: 0 0 4px rgba(0,0,0,0.6);
  pointer-events: none;
}
#status {
  margin-top: var(--space);
  text-align: center;
  font-family: var(--mono);
  font-size: 1rem;
  color: var(--muted);
}
#info {
  margin-top: var(--space);
  text-align: center;
  font-family: var(--mono);
  font-size: 2.4rem;
}
</style>
</head>
<body>
<header>
  <h1>Microwave Timer<small>display fix</small></h1>
</header>
<div id="card">
  <div id="controls">
    <div class="field">
      <label>Start <span id="startVal" class="value-display">13 °C</span></label>
      <input id="startTemp" type="range" min="5" max="20" step="0.1" value="13">
    </div>
    <div class="field">
      <label>Target <span id="targetVal" class="value-display">80 °C</span></label>
      <input id="targetTemp" type="range" min="75" max="90" step="1" value="80">
    </div>
    <details>
      <summary>Advanced</summary>
      <label>Water mass (g)<input id="waterMass" type="number" value="303" step="1"></label>
      <label>Mug mass (g)<input id="mugMass" type="number" value="250" step="1"></label>
      <label>P₀ (W)<input id="power0" type="number" value="600" step="10"></label>
      <label>hA (W / °C)<input id="heatLoss" type="number" value="1.1" step="0.1"></label>
      <label>Room T (°C)<input id="roomTemp" type="number" value="22" step="0.1"></label>
    </details>
  </div>
  <button id="startBtn" type="button">START</button>
  <div id="progressWrap"><div id="progressBar"></div><span id="barLabel"></span></div>
  <div id="status"></div>
  <div id="info"></div>
</div>
<footer>tap anywhere to stop flashing</footer>
<script>
// persistence
const KEY="microwaveTimerSettings";
function saveSettings(){
  localStorage.setItem(KEY, JSON.stringify({
    start:+startTemp.value,target:+targetTemp.value,
    water:+waterMass.value,mug:+mugMass.value,
    P0:+power0.value,hA:+heatLoss.value,room:+roomTemp.value
  }));
}
function loadSettings(){
  try{
    const d=JSON.parse(localStorage.getItem(KEY)||"{}");
    if(d.start) startTemp.value=d.start;
    if(d.target) targetTemp.value=d.target;
    if(d.water) waterMass.value=d.water;
    if(d.mug) mugMass.value=d.mug;
    if(d.P0) power0.value=d.P0;
    if(d.hA) heatLoss.value=d.hA;
    if(d.room) roomTemp.value=d.room;
  }catch{}
}

// helpers
const $=id=>document.getElementById(id);
function fmtTime(s){
  s=Math.max(0,Math.round(s));const m=Math.floor(s/60),sec=s%60;
  return m? m+":"+sec.toString().padStart(2,"0") : sec.toString();
}

// model
const cW=4186, cC=880;
function getParams(){
  const T0=+startTemp.value, Tt=+targetTemp.value,
        mW=+waterMass.value/1000, mM=+mugMass.value/1000,
        P0=+power0.value, hA=+heatLoss.value, Ta=+roomTemp.value;
  return {T0,Tt,P0,hA,Ta,MC:mW*cW + mM*cC};
}
function predictTime(p){
  if(p.Tt<=p.T0) return null;
  if(p.P0<=p.hA*(p.Tt-p.Ta)) return Infinity;
  return (p.MC/p.hA)*Math.log((p.P0-p.hA*(p.T0-p.Ta))/(p.P0-p.hA*(p.Tt-p.Ta)));
}

// state
let heatInt, coolInt, flashInt, sim,nullFinish, state="idle";

// UI initial and update
function updateControls(){
  $('startVal').textContent = startTemp.value+" °C";
  $('targetVal').textContent = targetTemp.value+" °C";
  const t = predictTime(getParams());
  $('info').textContent = isFinite(t)? fmtTime(t)+" s" : "∞";
  saveSettings();
}
function setState(s){
  state=s;
  if(s==="idle"){
    $('startBtn').style.display='block';
    $('progressWrap').style.display='none';
  } else {
    $('startBtn').style.display='none';
    $('progressWrap').style.display='block';
  }
  $('status').textContent = s==="heating"? "Heating": s==="paused"? "Paused": "";
}

// start heating
function start(){
  updateControls();
  const p=getParams(), total=predictTime(p);
  if(!isFinite(total)) return;
  sim={p,startTime:Date.now(),total};
  state="heating"; setState("heating");
  clearAll();
  heatStep(); heatInt=setInterval(heatStep,1000);
}

// heating tick
function heatStep(){
  const {p,startTime,total}=sim;
  const elapsed=(Date.now()-startTime)/1000;
  const rem=Math.max(0,total-elapsed);
  const frac=Math.min((elapsed/total)*100,100);
  $('progressBar').style.width=frac+'%';
  const T=p.Ta + p.P0/p.hA - (p.P0/p.hA - (p.T0-p.Ta))*Math.exp(-p.hA*elapsed/p.MC);
  $('barLabel').textContent=T.toFixed(1)+"°";
  $('info').textContent=fmtTime(rem)+" s";
  if(rem<=0){
    clearInterval(heatInt);
    state="paused"; setState("paused");
    $('info').textContent="0 s";
    playChime(); beginFlash();
    nullFinish=finishTime=Date.now();
    coolInt=setInterval(coolStep,1000);
  }
}

// cooling tick
function coolStep(){
  const {p}=sim;
  const elapsed=(Date.now()-finishTime)/1000;
  const T=p.Ta+(p.Tt-p.Ta)*Math.exp(-p.hA*elapsed/p.MC);
  const frac=Math.min(((T-p.Ta)/(p.Tt-p.Ta))*100,100);
  $('progressBar').style.width=frac+'%';
  $('barLabel').textContent=T.toFixed(1)+"°";
}

// toggle pause/resume
$('progressWrap').addEventListener('click',()=>{
  if(state==="heating"){
    clearInterval(heatInt);
    state="paused"; setState("paused");
    finishTime=Date.now(); clearInterval(coolInt); coolInt=setInterval(coolStep,1000);
  } else if(state==="paused"){
    clearInterval(coolInt);
    const {p,total} = sim;
    const current= parseFloat($('barLabel').textContent);
    const frac=(current-p.Ta)/(p.Tt-p.Ta);
    const elapsed=total*frac;
    sim.startTime=Date.now()-elapsed*1000;
    state="heating"; setState("heating");
    heatStep(); heatInt=setInterval(heatStep,1000);
  }
});

// chime & flash
function playChime(){
  const ctx=new(window.AudioContext||window.webkitAudioContext)();
  const o=ctx.createOscillator(),g=ctx.createGain();
  o.type="sine";o.frequency.value=1047;g.gain.value=0.3;
  o.connect(g).connect(ctx.destination);o.start();o.stop(ctx.currentTime+1);
}
function beginFlash(){
  let on=false; clearInterval(flashInt);
  flashInt=setInterval(()=>{on=!on;document.body.classList.toggle('flash-green',on);},500);
}
document.body.addEventListener('click',()=>{
  clearInterval(flashInt); clearInterval(coolInt);
  document.body.classList.remove('flash-green');
});

// clear all
function clearAll(){
  clearInterval(heatInt); clearInterval(coolInt); clearInterval(flashInt);
}

// bind
$('startBtn').addEventListener('click',start);
[startTemp,targetTemp,waterMass,mugMass,power0,heatLoss,roomTemp].forEach(el=>{
  el.addEventListener('input',updateControls);
  el.addEventListener('change',updateControls);
});
// init
loadSettings(); updateControls();
</script>
</body>
</html>
